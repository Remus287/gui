
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sensor Data</title>
    <script src="{{ url_for('static', filename='socket.io.js') }}"></script>
    <script src="{{ url_for('static', filename='makeChart.js') }}"></script>
    <script> var sensorList = []; </script>
</head>

<style>
    body {
        font-family: Arial, sans-serif;
        background-color: #21262d;
        color: #ecf2f8;
        height: 100%;
        column-gap: 10px;
        margin: 0;
        font-size: 14px;
        border-collapse: collapse;
        display: block;
    }
    button {
        cursor: pointer;
        border: none;
        border-radius: 5px;
    }
    .sidebar{
        position: fixed;
        top: 40px;
        height: 100%;
        width: 60px;
        background-color:#161b22;
        text-align: center;
    }
    #listContainer {
        position: fixed; 
        top: 40px;
        left: -10px;
        width: calc(100% - 60px);
        margin: 0 0 0 70px;
        float: left;
        max-height: 0;
        overflow: hidden;
        background-color:#21262d;
    }
    input:checked ~ #listContainer{
        max-height: 200px;
        overflow-y: auto;
    }
    input:checked ~ #chartContainer{
        top: 200px;
        height: calc(100% - 260px);
    }
    #chartContainer{
        position: fixed;
        top: 50px;
        left: 70px;
        height: calc(100% - 60px);
        width: calc(100% - 70px);
        overflow-y: auto;
    }
    #addChart {
        margin-bottom: 1%;
    }
    canvas {
        float: left;
        background-color: #ecf2f8;
        color: #161b22;
    }
    .container {
        position: relative;
        float: left;
        min-width: 250px;
        margin: 10px;
        padding: 10px;
        background-color: #ecf2f8;
    }
    .removeButton {
        position: absolute;
        top: 0;
        right: 0;
        font-size: 15px;
    }
    #titleBar{
        position: fixed;
        display: grid;
        align-items: center;
        width: 100%;
        height: 40px;
        background-color: #161b22;
        padding-left: 20px;
        margin-bottom: 10px;
    }
    table {
        width: 100%;
        text-align: center;
    }
    th {
        padding: 10px 5px; 
    }

    table, th, td {
        border: solid;
        border-collapse: collapse;
    }
    
</style>

<body>
    <div id = "titleBar">
        <b>Sensors</b>
    </div>

    <div class = "sidebar">
        <input type = "checkbox" id = "table" style = "display: none">
        <label for = "table" title = "show table" style = "cursor: pointer;"><img src = "../static/icons/table_icon.png" style = "width: 30px; margin-top: 10px;"></label>
        <div id = "listContainer">
            <table id="sensorsTable">
                <thead style = "background-color:#ecf2f8; color:#161b22">
                    <tr>
                        <th>Sensor Name</th>
                        <th>Data</th>
                        <th>Units</th>
                        <th>Tare</th>
                    </tr>
                </thead>
                <tbody>
                    {% for sensor in sensor_list %}
                        <tr>
                            <td>{{ sensor['P and ID'] }}</td>
                            <td id="{{ sensor['P and ID'] }}_data" style="min-width: 100px; max-width: 100px; overflow-wrap: break-word;">No Data</td>
                            <td>{{ sensor['Unit'] }}</td>
                            <td><button id="{{ sensor['P and ID'] }}" onclick="tare(id, true)" >Tare</button><button id="{{ sensor['P and ID'] }}" onclick="tare(id, false)"  >Untare</button></td>
                            <script> sensorList.push("{{ sensor['P and ID'] }}") </script>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <button id="addChart" title = "add chart" onClick = "addChart()" style = "margin-top: 20px; background-color: transparent;"><img src = "../static/icons/add_icon.png" style = "width: 30px"></button>
        <div id="chartContainer"></div>
    </div>

    

    

    <script>

        var socket = io.connect('http://' + document.domain + ':' + location.port);

        socket.on('sensor_data', function (sensorDataDict) {
            for(const [sensorID, sensorValue] of Object.entries(sensorDataDict)){
                document.getElementById(sensorID + '_data').textContent = sensorValue.toFixed(3);
            }
            // second param is number of data points to store for graphing
            updateData(sensorDataDict, 20*15);

            // plot updated data for each chart
            const containerList = document.getElementsByTagName('container');
            for (container of containerList){
                plotLines(container.id.replace("container", ""));
            }
        });

        function tare(sensorID, state) {
            socket.emit('tare', sensorID, state);
        }


        socket.on('responding_with_button_data', function (data) {
            buttonID = data[0]
            buttonState = data[1]

            const a = document.getElementById("" + buttonID + "_state");

            if (buttonState === 'untare'){
                a.textContent = buttonState;

            } else if (buttonState === 'tare'){
                a.textContent = buttonState;

            } else {
                console.log("error!!!");
            }


        });

        socket.on('sensor_and_actuator_config_uploaded', function() {
            location.reload();
        });

        var chartCounter = 1;


        function addChart(){
            const chartNumber = chartCounter;
            chartCounter ++;

            // create new div for chart and checkboxes
            var container = document.createElement("container");
            container.id = "container" + chartNumber;
            container.className = "container";
            container.setAttribute("style", "width: calc(50% - 40px);");
            document.getElementById("chartContainer").appendChild(container);

            // create new canvas in chartContainer
            var canvas = document.createElement("canvas");
            canvas.id = "chart" + chartNumber;
            container.appendChild(canvas);
            canvas.width = canvas.parentElement.clientWidth - 20;


            var removeButton = document.createElement("button");
            removeButton.id = "removeButton" + chartNumber;
            removeButton.textContent = "X";
            removeButton.className = "removeButton"
            removeButton.addEventListener('click', function() {
                removeChart(chartNumber);
            });
            container.appendChild(removeButton);

            createEmptyChart(container.id, sensorList);
        }

        function removeChart(chartNumber){
            containerID = "container" + chartNumber;
            const container = document.getElementById(containerID);
            document.getElementById("chartContainer").removeChild(container);
            removeCheckboxes(containerID, sensorList);
        }


        let pingTimeout;

        socket.on('ping', function (time) {
            // Update ping display
            document.getElementById("ping").textContent = `Ping: ${(Date.now() - time).toFixed(0)} milliseconds`;

            // Clear the timeout when the pong response is received
            clearTimeout(pingTimeout);

            // Set a new timeout for the next expected ping
            pingTimeout = setTimeout(function() {
                const a = document.getElementById("ping");
                a.textContent = "Server not responding";
                location.reload();
            }, 2000 + 1000); // If we get ping 1 second late attempt reload
        });

        socket.on('disconnect', function (reason) {
            console.log("Disconnected from server, reason: " + reason);
            close();
        });

    </script>

</body>

</html>
